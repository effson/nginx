# 1 æ¨¡å—åŠŸèƒ½æ¦‚è¿°
Nginx çš„ referer æ¨¡å—ï¼ˆå…¨ç§°ï¼šngx_http_referer_moduleï¼‰ï¼Œ**ä¸»è¦ç”¨äº é˜²æ­¢â€œç›—é“¾â€ï¼ˆHotlinkingï¼‰ï¼Œå³ç¦æ­¢å¤–éƒ¨ç½‘ç«™ç›´æ¥å¼•ç”¨æœåŠ¡å™¨ä¸Šçš„å›¾ç‰‡ã€è§†é¢‘ã€ä¸‹è½½èµ„æºç­‰å†…å®¹**ã€‚<br>
å¤–éƒ¨ç½‘ç«™é€šè¿‡urlå¼•ç”¨é¡µé¢ï¼Œç”¨æˆ·åœ¨æµè§ˆå™¨ç‚¹å‡»urlæ—¶ï¼Œhttpè¯·æ±‚çš„å¤´éƒ¨ä¼šé€šè¿‡**refererå¤´éƒ¨**ï¼Œå°†è¯¥ç½‘ç«™å½“å‰é¡µé¢çš„urlå¸¦ä¸Šï¼Œå‘Šè¯‰æœåŠ¡å™¨æœ¬æ¬¡è¯·æ±‚æ˜¯ç”±è¿™ä¸ªæµè§ˆå™¨é¡µé¢å‘èµ·çš„ã€‚<br>

<mark>**æ ¸å¿ƒåŠŸèƒ½ï¼šæ ¹æ®è¯·æ±‚å¤´ä¸­çš„ Referer å­—æ®µæ¥åˆ¤æ–­è¯·æ±‚æ¥æºï¼Œå…è®¸æˆ–æ‹’ç»æ¥è‡ªç‰¹å®šç«™ç‚¹çš„è®¿é—®**ã€‚</mark>




# 2.æ¨¡å—åŠ è½½
- æ¨¡å—åï¼š<mark>**ngx_http_referer_module**</mark>
- ç±»å‹ï¼šHTTPè®¿é—®æ§åˆ¶æ¨¡å—
- é»˜è®¤å·²å†…ç½®ï¼Œæ— éœ€ --with- å‚æ•°
- æ‰€å±é˜¶æ®µï¼š<mark>**ACCESS**</mark>


# 3. ä¸»è¦æŒ‡ä»¤

## 3.1 valid_referers
æŒ‡å®šå…è®¸è®¿é—®çš„ Referer æ¥æºè§„åˆ™ã€‚å‘Šè¯‰ Nginx å“ªäº›æ¥æºçš„è¯·æ±‚è¢«è®¤ä¸ºæ˜¯â€œåˆæ³•â€çš„ã€‚

### è¯­æ³•

```
valid_referers none | blocked | server_names | string ...;
```
- noneï¼šæ²¡æœ‰ Referer å¤´çš„è¯·æ±‚è§†ä¸ºåˆæ³•ï¼ˆç›´æ¥è®¿é—®ï¼‰
- blockedï¼šReferer å­˜åœ¨ä½†è¢«é˜²ç«å¢™æˆ–ä»£ç†éšè—ï¼ˆä¸æ˜¯ä»¥ http/https å¼€å¤´ï¼‰
- server_namesï¼šå…è®¸æœ¬æœåŠ¡å™¨é…ç½®çš„æ‰€æœ‰ server_name åŸŸå
- stringï¼šæ˜ç¡®åˆ—å‡ºå…è®¸çš„åŸŸåï¼ˆå¯å¸¦é€šé…ç¬¦ï¼‰





```
â€œreferer æ¨¡å—â€å®é™…ä¸ŠæŒ‡çš„æ˜¯ ngx_http_referer_moduleï¼Œè¿™æ˜¯ä¸€ä¸ªå†…å»ºçš„æ¨¡å—ï¼Œç”¨äºåŸºäº $http_referer è¯·æ±‚å¤´åšé˜²ç›—é“¾æ§åˆ¶ã€‚

ğŸ”¹ referer æ¨¡å—çš„ä½œç”¨
ç”¨äºé˜²æ­¢å¤–éƒ¨ç«™ç‚¹ç›´æ¥å¼•ç”¨ä½ çš„èµ„æºï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ç­‰é™æ€æ–‡ä»¶ã€‚
æ ¸å¿ƒç›®çš„æ˜¯ï¼šåªæœ‰æ¥è‡ªä½ å…è®¸çš„ Referer çš„è¯·æ±‚ï¼Œæ‰èƒ½è®¿é—®èµ„æºï¼Œå¦åˆ™è¿”å› 403 æˆ–å…¶å®ƒè‡ªå®šä¹‰å“åº”ã€‚

ğŸ”¹ å¯ç”¨å’Œä½¿ç”¨æ–¹å¼
referer æ¨¡å—é»˜è®¤ç¼–è¯‘è¿› Nginxï¼Œæ— éœ€é¢å¤–å®‰è£…ï¼Œåªéœ€åœ¨é…ç½®ä¸­ä½¿ç”¨å®ƒçš„æŒ‡ä»¤ã€‚

âœ… å…³é”®æŒ‡ä»¤
æŒ‡ä»¤	ä½œç”¨
valid_referers	è®¾ç½®å…è®¸è®¿é—®çš„å¼•ç”¨æ¥æºï¼ˆå¯åŒ¹é…å¤šä¸ªåŸŸåæˆ–å…³é”®å­—ï¼‰
$invalid_referer	å†…ç½®å˜é‡ï¼Œç”¨äºåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦ä¸ºéæ³•å¼•ç”¨

ğŸ”¹ ç¤ºä¾‹ï¼šé˜²ç›—é“¾é…ç½®ï¼ˆå›¾ç‰‡é˜²ç›—é“¾ï¼‰
location ~* \.(jpg|jpeg|png|gif|webp)$ {
    valid_referers none blocked *.yourdomain.com www.yourdomain.com;
    
    if ($invalid_referer) {
        return 403;  # éæ³•å¼•ç”¨åˆ™æ‹’ç»è®¿é—®
    }

    # åˆæ³•å¼•ç”¨å¯è®¿é—®å›¾ç‰‡èµ„æº
    root /var/www/html;
}
å„å‚æ•°è§£é‡Šï¼š
noneï¼šè¡¨ç¤ºæ²¡æœ‰ Referer çš„è¯·æ±‚ï¼ˆæ¯”å¦‚ç›´æ¥è¾“å…¥ç½‘å€ï¼‰ä¹Ÿè¢«å…è®¸ã€‚
blockedï¼šè¡¨ç¤º Referer è¢«æŸäº›ä»£ç†æˆ–æµè§ˆå™¨éšè—ï¼ˆReferer è¢«æ¸…ç©ºï¼‰ä¹Ÿè¢«å…è®¸ã€‚
*.yourdomain.comï¼šå…è®¸ä»ä½ è‡ªå·±çš„ç½‘ç«™å¼•ç”¨å›¾ç‰‡ã€‚
$invalid_refererï¼šä¸º 1 è¡¨ç¤ºä¸åˆæ³•ï¼ˆå³ Referer ä¸åœ¨ç™½åå•ä¸­ï¼‰ã€‚

ğŸ”¹ æ›´å¼ºçš„ä¾‹å­ï¼šè‡ªå®šä¹‰è¿”å›å†…å®¹
if ($invalid_referer) {
    return 403 "Access Denied: Invalid Referer";
}

æˆ–è¿”å›ä¸€å¼ è­¦å‘Šå›¾ç‰‡ï¼š
if ($invalid_referer) {
    rewrite ^ /images/anti_steal.jpg;
}
ğŸ”¹ æ—¥å¿—è®°å½•éæ³•è®¿é—®è€…
log_format referer_log '[$time_local] $remote_addr tried to access $request_uri with referer: $http_referer';

access_log /var/log/nginx/referer.log referer_log if=$invalid_referer;
âœ… æ€»ç»“
åŠŸèƒ½	å®ç°æ–¹å¼
é˜²æ­¢ç›—é“¾	valid_referers + $invalid_referer
ç™½åå•æ§åˆ¶	å…è®¸è‡ªå·±çš„åŸŸåæˆ–ç©º Referer
æ—¥å¿—è®°å½•éæ³•	access_log æ­é… $invalid_referer
```
