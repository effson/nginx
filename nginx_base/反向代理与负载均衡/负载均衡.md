# upstream & server 指令指定上游服务地址

```nginx
upstream name {...}

server address [parameters]; 
```
简单示例:

```nginx
upstream backend {
    server 10.0.0.1;
    server 10.0.0.2;
    server 10.0.0.3;
}

server {
    listen 80;
    location / {
        proxy_pass http://backend;
    }
}
```

# 1. 负载均衡 Round Robin算法
Nginx 将来自客户端的请求按顺序、依次分配给每个上游服务器（upstream server）。

## 1.1 带权重的 Round Robin（Weighted Round Robin）
### 1.1.1 weight
设置服务器权重，默认=1
```nginx
upstream backend {
    server 10.0.0.1 weight=3;
    server 10.0.0.2 weight=1;
}
```
### 1.1.2 max_fails
指定连续失败次数后将服务器标记为不可用

### 1.1.3 fail_timeout
指定服务器被标记为不可用的时间


# 2. 对上游服务使用keep-alive长连接

## 2.1 按协议的必备配置
**Nginx 默认用 HTTP/1.0 与上游通信，会关连接**；
```nginx
location / {
    proxy_http_version 1.1;        # 必须：启用 HTTP/1.1 才能复用
    proxy_set_header Connection ""; # 不给上游发送 "Connection: close"
    # ...

    proxy_pass http://backend;     # 指向上面的 upstream
}
```
## 2.2 upstream_keepalive指令
在 upstream 池里开启连接缓存
```nginx
upstream backend {
    server 10.0.0.1:8080;
    server 10.0.0.2:8080;

    keepalive 128;              # 每个 worker 为该 upstream 缓存的空闲连接个数
    keepalive_timeout 60s;      # 空闲连接在池中的最长停留时间（建议设置）
    keepalive_requests 1000;    # 复用同一连接最多处理多少请求后主动关闭
}
```

## 2.3 上游服务的域名解析指令
### 2.3.1 resolver
指定 Nginx 向哪个 DNS 服务器解析域名
```nginx
resolver address ... [valid=time] [ipv6=on | off];
```


```nginx
resolver 8.8.8.8 114.114.114.114 valid=30s ipv6=off;
```

### 2.3.2 resolver_timeout
设置 DNS 查询的超时时间
```nginx
resolver_timeout time;
```





# 3. 负载均衡哈希算法

「负载均衡哈希算法」 是 Nginx 在 upstream 模块中提供的一类基于 哈希（Hash）值分配上游服务器 的算法，用来实现 请求一致性、会话粘性（session stickiness） 或 特定键路由 的负载均衡方式
## 3.1 ip_hash
按客户端 IP 进行哈希分配，简单、过时、不支持权重
```nginx
upstream backend {
    ip_hash;
    server 10.0.0.1:8080;
    server 10.0.0.2:8080;
}
```
按客户端 IP 哈希固定到某个上游


## 3.2 hash
```nginx
hash <key> [consistent];
```
- <key> : 用来计算哈希值的键（如 $request_uri、$remote_addr、$cookie_sessionid 等）
- [consistent] : 可选参数，启用一致性哈希（Consistent Hashing）算法

#### 普通哈希算法（非一致性）
```ini
index = hash($key) % N
```

```nginx
upstream backend {
    hash $request_uri;
    server 10.0.0.1;
    server 10.0.0.2;
    server 10.0.0.3;
}
```
#### 一致性哈希算法（Consistent Hashing）
一致性哈希通过在虚拟环上分布服务器节点，使得当上游数量变化时，只有 一小部分键会重新映射，从而保证缓存命中率和会话粘性稳定
```nginx
hash $remote_addr consistent;
```


# 4. 优先选择连接最少的上游服务器
