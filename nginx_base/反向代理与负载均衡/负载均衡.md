# upstream & server 指令指定上游服务地址

```nginx
upstream name {...}

server address [parameters]; 
```
简单示例:

```nginx
upstream backend {
    server 10.0.0.1;
    server 10.0.0.2;
    server 10.0.0.3;
}

server {
    listen 80;
    location / {
        proxy_pass http://backend;
    }
}
```

# 1. 负载均衡 Round Robin算法
Nginx 将来自客户端的请求按顺序、依次分配给每个上游服务器（upstream server）。

## 1.1 带权重的 Round Robin（Weighted Round Robin）
### 1.1.1 weight
设置服务器权重，默认=1
```nginx
upstream backend {
    server 10.0.0.1 weight=3;
    server 10.0.0.2 weight=1;
}
```
### 1.1.2 max_fails
指定连续失败次数后将服务器标记为不可用

### 1.1.3 fail_timeout
指定服务器被标记为不可用的时间


# 2. 对上游服务使用keep-alive长连接

## 2.1 按协议的必备配置
**Nginx 默认用 HTTP/1.0 与上游通信，会关连接**；
```nginx
location / {
    proxy_http_version 1.1;        # 必须：启用 HTTP/1.1 才能复用
    proxy_set_header Connection ""; # 不给上游发送 "Connection: close"
    # ...

    proxy_pass http://backend;     # 指向上面的 upstream
}
```
## 2.2 upstream_keepalive指令
在 upstream 池里开启连接缓存
```nginx
upstream backend {
    server 10.0.0.1:8080;
    server 10.0.0.2:8080;

    keepalive 128;              # 每个 worker 为该 upstream 缓存的空闲连接个数
    keepalive_timeout 60s;      # 空闲连接在池中的最长停留时间（建议设置）
    keepalive_requests 1000;    # 复用同一连接最多处理多少请求后主动关闭
}
```

## 2.3 上游服务的域名解析指令
### 2.3.1 resolver
指定 Nginx 向哪个 DNS 服务器解析域名
```nginx
resolver address ... [valid=time] [ipv6=on | off];
```


```nginx
resolver 8.8.8.8 114.114.114.114 valid=30s ipv6=off;
```

